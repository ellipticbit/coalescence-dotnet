before_script:
  - "git clean -fdxq"
  - "git submodule sync --recursive"
  - "git submodule foreach --recursive git reset --hard"
  - "git submodule update --init --recursive"

stages:
  - shared
  - library

Shared Test Deployment:
  stage: shared
  tags:
    - linux
    - dotnet

  except:
    refs:
      - master
  only:
    changes:
      - Shared/**/*

  script:
    - "dotnet restore ./Shared/Shared.csproj"
    - "dotnet pack -c Debug -o ./ ./Shared/Shared.csproj"

Shared Production Deployment:
  stage: shared
  tags:
    - linux
    - dotnet

  only:
    refs:
      - master
    changes:
      - Shared/**/*

  script:
    - "dotnet restore ./Shared/Shared.csproj"
    - "pwsh -f \"./ReplaceVersion-Shared.ps1\""
    - "dotnet pack -c Release -o ./ ./Shared/Shared.csproj"
    - "dotnet nuget push *.nupkg -k $NUGET_API_KEY -s \"https://www.nuget.org\""

Client Test Deployment:
  stage: library
  needs: ["Shared Test Deployment"]
  tags:
    - linux
    - dotnet

  except:
    refs:
      - master
  only:
    changes:
      - Request/**/*

  script:
    - "dotnet restore ./Request/Request.csproj"
    - "dotnet add ./Request/Request.csproj package EllipticBit.Hotwire.Shared"
    - "dotnet pack -c Debug -o ./ ./Request/Request.csproj"

Client Production Deployment:
  stage: library
  needs: ["Shared Production Deployment"]
  tags:
    - linux
    - dotnet

  only:
    refs:
      - master
    changes:
      - Request/**/*

  script:
    - "dotnet restore ./Request/Request.csproj"
    - "pwsh -f \"./ReplaceVersion-Request.ps1\""
    - "dotnet add ./Request/Request.csproj package EllipticBit.Hotwire.Shared"
    - "dotnet pack -c Release -o ./ ./Request/Request.csproj"
    - "dotnet nuget push *.nupkg -k $NUGET_API_KEY -s \"https://www.nuget.org\""
